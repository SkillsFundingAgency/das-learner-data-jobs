parameters:
  SolutionBaseName:
  BuildConfiguration:

jobs:
- job: CodeBuild
  pool:
    name: DAS - Continuous Integration Agents
    workspace:
      clean: all
  variables:
    - group: BUILD Management Resources
  steps:
    - template: azure-pipelines-templates/build/step/gitversion.yml@das-platform-building-blocks

    - template: azure-pipelines-templates/build/step/app-build.yml@das-platform-building-blocks
      parameters:
        ContinueOnVulnerablePackageScanError: true

    - task: DotNetCoreCLI@2
      displayName: Publish - ProcessLearners Function App
      inputs:
        command: publish
        publishWebProjects: false
        projects: src/${{ parameters.SolutionBaseName }}.Functions.ProcessLearners/${{ parameters.SolutionBaseName }}.Functions.ProcessLearners.csproj
        arguments: -o $(build.artifactstagingdirectory)/publish/ProcessLearners -c ${{ parameters.BuildConfiguration }} --no-build
        modifyOutputPath: true
        zipAfterPublish: true

    - task: DotNetCoreCLI@2
      displayName: Publish - Approvals Function App
      inputs:
        command: publish
        publishWebProjects: false
        projects: src/${{ parameters.SolutionBaseName }}.Functions.Approvals/${{ parameters.SolutionBaseName }}.Functions.Approvals.csproj
        arguments: -o $(build.artifactstagingdirectory)/publish/Approvals -c ${{ parameters.BuildConfiguration }} --no-build
        modifyOutputPath: true
        zipAfterPublish: true

    - task: CopyFiles@2
      displayName: Copy Azure Files for ProcessLearners
      inputs:
        Contents: |
          azure/**
        TargetFolder: $(build.artifactstagingdirectory)/publish/ProcessLearners
        OverWrite: true

    - task: CopyFiles@2
      displayName: Copy Azure Files for Approvals
      inputs:
        Contents: |
          azure/**
        TargetFolder: $(build.artifactstagingdirectory)/publish/Approvals
        OverWrite: true

    - task: PublishPipelineArtifact@1
      displayName: Publish Build Artifact - ProcessLearners
      inputs:
        targetPath: $(build.artifactstagingdirectory)/publish/ProcessLearners
        artifactName: ${{ parameters.SolutionBaseName }}.Functions.ProcessLearners

    - task: PublishPipelineArtifact@1
      displayName: Publish Build Artifact - Approvals
      inputs:
        targetPath: $(build.artifactstagingdirectory)/publish/Approvals
        artifactName: ${{ parameters.SolutionBaseName }}.Functions.Approvals
